<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant Farm Simulator</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="ant-farm.css">
</head>
<body>
    <header id="site-header">
        <nav>
            <a href="index.html">Home</a> |
            <a href="rps.html">RPS</a> |
            <a href="art.html">Art</a> |
            <a href="ant-farm.html">Ant Farm</a>
        </nav>
    </header>
    <main>
        <div class="controls-parent">
            <!-- Ant and Red Ant Controls -->
            <div class="controls-section">
                <h1>Ant Controls</h1>
                <button id="add-ant">Add Ant</button>
                <label for="mating-slider">Mating Conditions:</label>
                <input type="range" id="mating-slider" min="1" max="100" value="20">
                <label for="lifespan-slider-normal">Normal Ant Lifespan (seconds):</label>
                <input type="range" id="lifespan-slider-normal" min="10" max="300" value="120">
            </div>
            <div class="controls-section">
                <h2>Red Ant Controls</h2>
                <button id="add-red-ant">Add Red Ant</button>
                <label for="lifespan-slider-red">Red Ant Lifespan (seconds):</label>
                <input type="range" id="lifespan-slider-red" min="10" max="300" value="120">
                <label><input type="checkbox" id="allow-red-breeding" checked> Allow Red Ant Breeding</label>
                <label for="red-aggression-slider">Red Ant Aggression:</label>
                <input type="range" id="red-aggression-slider" min="0" max="100" value="50">
            </div>
            <div class="controls-section">
                <label for="food-type">Select Food:</label>
                <select id="food-type">
                    <option value="sugar" style="color:white;font-weight:bold;">Sugar</option>
                    <option value="protein" style="color:green;font-weight:bold;">Protein</option>
                    <option value="spoiled" style="color:blue;font-weight:bold;">Spoiled</option>
                    <option value="poison" style="color:purple;font-weight:bold;">Poison</option>
                </select>
            </div>
            <div class="controls-section danger-zone">
                <h2 style="color: red;">Danger Zone</h2>
                <button id="kill-red-ants" class="kill-all">Kill All Red Ants</button>
                <button id="kill-all-ants" class="kill-all">Kill All Ants</button>
                <button id="destroy-world" class="kill-all">Destroy World</button>
            </div>
            <div id="stats" class="controls-section">
                Total Alive: 0<br>
                White Ants: Alive: 0 | Born: 0 | Dead: 0<br>
                Red Ants: Alive: 0 | Born: 0 | Dead: 0
            </div>
            <div class="controls-section">
                <h2>User Controls</h2>
                <button id="pause-resume">Pause</button>
            </div>
        </div>
        <div class="canvas-container">
            <div id="happiness-bar-container">
                <div id="happiness-bar"></div>
            </div>
            <canvas id="antCanvas" width="1000" height="600"></canvas>
        </div>
    </main>
    <script>
        const SAVE_KEY = 'antFarmSave';
        const MAX_WHITE_ANTS = 500;
        const MAX_RED_ANTS = 500;
        const MAX_FOOD = 300;
        let ants = [], foods = [], pheromones = [], environment = [];
        let animationPaused = false;
        let queens = {
            white: null,
            red: null
        };
        let whiteHappiness = 50;
        let matingSpeed = 5000, allowRedBreeding = true, redAggressionLevel = 50;
        let totalBornWhite = 0, totalDeadWhite = 0, totalBornRed = 0, totalDeadRed = 0;
        let normalAntLifespan = 10000, redAntLifespan = 10000;
        let canvas, ctx;

        window.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('antCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            loadFarm();
            setupUI();
            animate();
        });

        function resizeCanvas() {
            canvas.width = Math.max(200, Math.min(window.innerWidth - 320, 1000));
            canvas.height = window.innerHeight - 160;
        }

        function setupUI() {
            const get = id => document.getElementById(id);
            get('add-ant').addEventListener('click', () => {
                if (countWhiteAnts() < MAX_WHITE_ANTS) {
                    ants.push(createAnt(false)); totalBornWhite++; updateStats(); saveFarm();
                }
            });
            get('add-red-ant').addEventListener('click',
                () => {
                    if (countRedAnts() < MAX_RED_ANTS) {
                        ants.push(createAnt(true)); totalBornRed++; updateStats(); saveFarm();
                    }
                });
            get('kill-all-ants').addEventListener('click',
                () => {
                    ants = []; updateStats(); saveFarm();
                });
            get('destroy-world').addEventListener('click',
                () => {
                    ants = []; foods = []; pheromones = []; environment = []; queens.white = null; queens.red = null; whiteHappiness = 50;
                    totalBornWhite = 0; totalDeadWhite = 0; totalBornRed = 0; totalDeadRed = 0;
                    ctx.clearRect(0, 0, canvas.width, canvas.height); updateStats(); saveFarm();
                });
            get('pause-resume').addEventListener('click',
                e => {
                    animationPaused = !animationPaused; e.target.innerText = animationPaused ? 'Resume': 'Pause';
                });
            get('allow-red-breeding').addEventListener('change',
                e => {
                    allowRedBreeding = e.target.checked; saveFarm();
                });
            get('kill-red-ants').addEventListener('click',
                () => {
                    ants = ants.filter(a => !a.isRed); updateStats(); saveFarm();
                });
            get('mating-slider').addEventListener('input',
                e => {
                    matingSpeed = 10000 - (e.target.value * 90); saveFarm();
                });
            get('lifespan-slider-normal').addEventListener('input',
                e => {
                    normalAntLifespan = e.target.value * 1000; saveFarm();
                });
            get('lifespan-slider-red').addEventListener('input',
                e => {
                    redAntLifespan = e.target.value * 1000; saveFarm();
                });
            get('red-aggression-slider').addEventListener('input',
                e => {
                    redAggressionLevel = e.target.value; saveFarm();
                });
            canvas.addEventListener('click',
                e => {
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    const tool = document.getElementById('draw-tool').value;
                    if (tool === 'food') {
                        const foodType = document.getElementById('food-type').value || 'sugar';
                        if (foods.length < MAX_FOOD) foods.push({
                            x, y, type: foodType
                        });
                    } else if (tool === 'wall' || tool === 'water') {
                        environment.push({
                            x, y, type: tool
                        });
                    } else if (tool === 'bulldozer') {
                        environment = environment.filter(obj => Math.hypot(obj.x - x, obj.y - y) > 10);
                    }
                    saveFarm();
                });
            get('delete-structures').addEventListener('click',
                () => {
                    environment = []; saveFarm();
                });
        }

        function countWhiteAnts() {
            return ants.filter(a => !a.isRed).length;
        }
        function countRedAnts() {
            return ants.filter(a => a.isRed).length;
        }

        function createAnt(isRed = false, isQueen = false) {
            const baseLife = isRed ? redAntLifespan: normalAntLifespan;
            const jitter = (Math.random() * 0.2 - 0.1);
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                angle: Math.random() * Math.PI * 2,
                isRed, isQueen,
                speed: isQueen ? 0: (isRed ? 2: 1),
                breedingTimer: 0,
                lifespan: isQueen ? Infinity: baseLife * (1 + jitter),
                spawnTimer: 0,
                followTarget: null
            };
        }

        function animate() {
            ctx.clearRect(0,
                0,
                canvas.width,
                canvas.height);
            drawEnvironment();
            drawFoods();
            drawPheromones();

            adjustWhiteHappiness();
            updateWhiteHappinessBar();

            if (!animationPaused) {
                moveAndDrawAnts();
            } else {
                ants.forEach(drawAnt);
                if (queens.white) drawAnt(queens.white);
                if (queens.red) drawAnt(queens.red);
            }

            requestAnimationFrame(animate);
        }

        function updateWhiteHappinessBar() {
            const bar = document.getElementById('happiness-bar');
            if (bar) {
                bar.style.width = `${whiteHappiness * 2}px`; // assuming 0–100 maps to 0–200px
                let color = 'lime';
                if (whiteHappiness < 25) color = 'red';
                else if (whiteHappiness < 50) color = 'orange';
                else if (whiteHappiness >= 75) color = queens.white ? 'purple': 'lime';
                bar.style.background = color;
            }
        }

        function drawEnvironment() {
            environment.forEach(obj => {
                ctx.beginPath();
                ctx.fillStyle = obj.type === 'wall' ? 'gray': 'blue';
                ctx.arc(obj.x, obj.y, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();
            });
        }

        function drawFoods() {
            foods.forEach(food => {
                ctx.beginPath();
                ctx.fillStyle = getFoodColor(food.type);
                ctx.arc(food.x, food.y, 5, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();
            });
        }

        function drawPheromones() {
            pheromones = pheromones.filter(p => p.strength > 0);
            pheromones.forEach(p => {
                ctx.beginPath();
                ctx.fillStyle = `rgba(255, 255, 0, ${p.strength})`;
                ctx.arc(p.x, p.y, 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.closePath();
                p.strength -= 0.01;
            });
        }

        function getFoodColor(type) {
            switch (type) {
                case 'sugar': return 'white';
                    case 'protein': return 'green';
                        case 'spoiled': return 'blue';
                            case 'poison': return 'purple';
                                default: return 'white';
                                }
                        }

                        function updateWhiteHappinessBar() {
                            const bar = document.getElementById('happiness-bar');
                            bar.style.width = `${whiteHappiness * 2}px`; // since max width is 200px
                            let color = 'lime';
                            if (whiteHappiness < 25) color = 'red';
                            else if (whiteHappiness < 50) color = 'orange';
                            else if (whiteHappiness >= 75) color = queens.white ? 'purple': 'lime';
                            bar.style.background = color;
                    }

                    function drawAnt(ant) {
                        ctx.beginPath();
                        ctx.fillStyle = ant.isRed ? 'red': 'white';
                        const radius = ant.isQueen ? 20: 5;
                        ctx.arc(ant.x, ant.y, radius, 0, Math.PI * 2);
                        ctx.fill();
                        ctx.closePath();
                }

                function moveAndDrawAnts() {
                    adjustWhiteHappiness();
                    ants.forEach(drawAnt);
                    if (queens.white) drawAnt(queens.white);
                    if (queens.red) drawAnt(queens.red);

                    if (whiteHappiness >= 75 && !queens.white) queens.white = createAnt(false, true);
                    if (whiteHappiness < 25 && !queens.red) queens.red = createAnt(true, true);

                    for (let i = ants.length - 1; i >= 0; i--) {
                        const ant = ants[i];
                        ant.angle += (Math.random() - 0.5) * 0.2;

                        let blocked = environment.some(e => Math.hypot(e.x - ant.x, e.y - ant.y) < 5);
                        if (!ant.isQueen && !blocked) {
                            if (ant.isRed) {
                                const target = ants.find(a => !a.isRed);
                                if (target) {
                                    const angleTo = Math.atan2(target.y - ant.y, target.x - ant.x);
                                    ant.angle += (angleTo - ant.angle) * (redAggressionLevel / 100);
                                    if (Math.hypot(ant.x - target.x, ant.y - target.y) < 10) {
                                        ants.splice(ants.indexOf(target), 1);
                                        totalDeadWhite++;
                                        updateStats();
                                    }
                                }
                            } else {
                                const pheromone = pheromones.find(p => Math.hypot(p.x - ant.x, p.y - ant.y) < 20);
                                if (pheromone) {
                                    const angleToPheromone = Math.atan2(pheromone.y - ant.y, pheromone.x - ant.x);
                                    ant.angle += (angleToPheromone - ant.angle) * 0.05;
                                } else if (foods.length > 0) {
                                    const nearest = foods.reduce((a, b) => ((a.x - ant.x)**2 + (a.y - ant.y)**2) < ((b.x - ant.x)**2 + (b.y - ant.y)**2) ? a: b);
                                    const angleToFood = Math.atan2(nearest.y - ant.y, nearest.x - ant.x);
                                    ant.angle += (angleToFood - ant.angle) * 0.1;
                                    if (Math.hypot(ant.x - nearest.x, ant.y - nearest.y) < 10) {
                                        foods.splice(foods.indexOf(nearest), 1);
                                        pheromones.push({
                                            x: ant.x, y: ant.y, strength: 1
                                        });
                                    }
                                }
                            }
                            ant.x += Math.cos(ant.angle) * ant.speed;
                            ant.y += Math.sin(ant.angle) * ant.speed;
                            if (ant.x < 0) ant.x = canvas.width;
                            if (ant.x > canvas.width) ant.x = 0;
                            if (ant.y < 0) ant.y = canvas.height;
                            if (ant.y > canvas.height) ant.y = 0;
                        }

                        ants.forEach(other => {
                            if (other !== ant && Math.hypot(ant.x - other.x, ant.y - other.y) < 2) {
                                ant.angle += Math.PI / 2;
                            }
                        });

                        ant.lifespan -= 16;
                        if (ant.lifespan <= 0 && !ant.isQueen) {
                            if (ant.isRed) totalDeadRed++; else totalDeadWhite++;
                            ants.splice(i, 1);
                            updateStats();
                            continue;
                        }

                        ant.breedingTimer += 16;
                        if (ant.breedingTimer >= matingSpeed) {
                            tryBreeding(ant);
                            ant.breedingTimer = 0;
                        }

                        if (ant.isQueen) {
                            ant.spawnTimer += 16;
                            if (ant.spawnTimer >= 3000) {
                                ants.push(createAnt(ant.isRed));
                                if (ant.isRed) totalBornRed++; else totalBornWhite++;
                                ant.spawnTimer = 0;
                            }
                        }
                    }
            }

            function adjustWhiteHappiness() {
                let foodScore = foods.filter(f => f.type !== 'poison').length;
                let survivalScore = countWhiteAnts();
                let deathPenalty = totalDeadWhite;
                whiteHappiness = Math.max(0, Math.min(100, 50 + foodScore / 5 + survivalScore / 10 - deathPenalty / 20));
            }

            function tryBreeding(ant) {
                ants.forEach(other => {
                    if (other === ant || other.isQueen) return;
                    if (Math.hypot(ant.x - other.x, ant.y - other.y) < 30) {
                        if (ant.isRed && other.isRed) {
                            if (allowRedBreeding && countRedAnts() < MAX_RED_ANTS && Math.random() < 0.1) {
                                ants.push(createAnt(true));
                                totalBornRed++;
                            }
                        } else if (!ant.isRed && !other.isRed) {
                            if (countWhiteAnts() < MAX_WHITE_ANTS && Math.random() < 0.1) {
                                ants.push(createAnt(false));
                                totalBornWhite++;
                            }
                        }
                    }
                });
                updateStats();
            }

            function updateStats() {
                const el = document.getElementById('stats');
                if (el) el.innerHTML =
                `Total Alive: ${ants.length}<br>` +
                `White Ants: Alive: ${countWhiteAnts()} | Born: ${totalBornWhite} | Dead: ${totalDeadWhite}<br>` +
                `Red Ants: Alive: ${countRedAnts()} | Born: ${totalBornRed} | Dead: ${totalDeadRed}`;
            }

            function saveFarm() {
                const data = {
                    ants,
                    foods,
                    pheromones,
                    environment,
                    totalBornWhite,
                    totalDeadWhite,
                    totalBornRed,
                    totalDeadRed,
                    matingSpeed,
                    normalAntLifespan,
                    redAntLifespan,
                    allowRedBreeding,
                    redAggressionLevel,
                    whiteHappiness
                };
                localStorage.setItem(SAVE_KEY, JSON.stringify(data));
            }

            function loadFarm() {
                const saved = localStorage.getItem(SAVE_KEY);
                if (saved) {
                    const data = JSON.parse(saved);
                    ants = (data.ants || []).map(a => ({
                        ...a, breedingTimer: 0, angle: a.angle || Math.random() * Math.PI * 2, spawnTimer: 0
                    }));
                    foods = data.foods || [];
                    pheromones = data.pheromones || [];
                    environment = data.environment || [];
                    totalBornWhite = data.totalBornWhite || 0;
                    totalDeadWhite = data.totalDeadWhite || 0;
                    totalBornRed = data.totalBornRed || 0;
                    totalDeadRed = data.totalDeadRed || 0;
                    matingSpeed = data.matingSpeed || 5000;
                    normalAntLifespan = data.normalAntLifespan || 10000;
                    redAntLifespan = data.redAntLifespan || 10000;
                    allowRedBreeding = data.allowRedBreeding !== undefined ? data.allowRedBreeding: true;
                    redAggressionLevel = data.redAggressionLevel !== undefined ? data.redAggressionLevel: 50;
                    whiteHappiness = data.whiteHappiness !== undefined ? data.whiteHappiness: 50;
                    updateStats();
                }
            }

        </script>
    </body>
</html>