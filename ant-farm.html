<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant Farm Simulator</title>
    <link rel="stylesheet" href="global.css">
    <link rel="stylesheet" href="ant-farm.css">
</head>
<body>
    <header id="site-header">
        <nav>
            <a href="index.html">Home</a> |
            <a href="rps.html">RPS</a> |
            <a href="art.html">Art</a> |
            <a href="ant-farm.html">Ant Farm</a>
        </nav>
    </header>
    <main>
        <div class="controls-parent">
            <!-- Ant and Red Ant Controls -->
            <div class="controls-section">
                <h1>Ant Controls</h1>
                <button id="add-ant">Add Ant</button>
                <label for="mating-slider">Mating Conditions:</label>
                <input type="range" id="mating-slider" min="1" max="100" value="20">
                <label for="lifespan-slider-normal">Normal Ant Lifespan (seconds):</label>
                <input type="range" id="lifespan-slider-normal" min="10" max="300" value="120">
            </div>
            <div class="controls-section">
                <h2>Red Ant Controls</h2>
                <button id="add-red-ant">Add Red Ant</button>
                <label for="lifespan-slider-red">Red Ant Lifespan (seconds):</label>
                <input type="range" id="lifespan-slider-red" min="10" max="300" value="120">
                <label><input type="checkbox" id="allow-red-breeding" checked> Allow Red Ant Breeding</label>
                <label for="red-aggression-slider">Red Ant Aggression:</label>
                <input type="range" id="red-aggression-slider" min="0" max="100" value="50">
            </div>
            <div class="controls-section">
                <label for="food-type">Select Food:</label>
                <select id="food-type">
                    <option value="sugar" style="color:white;font-weight:bold;">Sugar</option>
                    <option value="protein" style="color:green;font-weight:bold;">Protein</option>
                    <option value="spoiled" style="color:blue;font-weight:bold;">Spoiled</option>
                    <option value="poison" style="color:purple;font-weight:bold;">Poison</option>
                </select>
            </div>
            <div class="controls-section">
                <h2>Environment Tools</h2>
                <select id="environment-tool">
                    <option value="none">None</option>
                    <option value="water"><b style="color:blue">Water</b></option>
                    <option value="wall"><b style="color:grey">Wall</b></option>
                    <option value="bulldozer"><b style="color:red">Bulldozer</b></option>
                </select>
                <button id="undo-structure">Undo Last</button>
                <button id="delete-structures">Delete All Structures</button>
            </div>

            <div class="controls-section danger-zone">
                <h2 style="color: red;">Danger Zone</h2>
                <button id="kill-red-ants" class="kill-all">Kill All Red Ants</button>
                <button id="kill-all-ants" class="kill-all">Kill All Ants</button>
                <button id="destroy-world" class="kill-all">Destroy World</button>
            </div>
            <div id="stats" class="controls-section">
                Total Alive: 0<br>
                Ants: Alive: 0 | Born: 0 | Dead: 0<br>
                Red Ants: Alive: 0 | Born: 0 | Dead: 0
            </div>
            <div class="controls-section">
                <h2>User Controls</h2>
                <button id="pause-resume">Pause</button>
            </div>
        </div>
        <div class="canvas-container">
            <div id="happiness-bar-container">
                <div id="happiness-bar"></div>
            </div>
            <canvas id="antCanvas" width="1000" height="600"></canvas>
        </div>
    </main>
    <<script>
        const SAVE_KEY = 'antFarmSave';
        const MAX_WHITE_ANTS = 500;
        const MAX_RED_ANTS = 500;
        const MAX_FOOD = 300;

        // State
        let ants = [], foods = [], pheromones = [], environment = [];
        let environmentHistory = [];

        let animationPaused = false;
        let queens = {
            white: null,
            red: null
        };
        let whiteHappiness = 50;
        let matingSpeed = 5000, allowRedBreeding = true, redAggressionLevel = 50;
        let totalBornWhite = 0, totalDeadWhite = 0, totalBornRed = 0, totalDeadRed = 0;
        let normalAntLifespan = 10000, redAntLifespan = 10000;

        let canvas, ctx;

        // Drawing helpers
        let isDrawing = false, lastX = null, lastY = null;

        // Utility: snapshot for undo
        function snapshotEnvironment() {
            environmentHistory.push(environment.slice());
            if (environmentHistory.length > 20) environmentHistory.shift();
        }

        // Map event → canvas coords
        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const cx = e.touches ? e.touches[0].clientX: e.clientX;
            const cy = e.touches ? e.touches[0].clientY: e.clientY;
            return {
                x: cx - rect.left,
                y: cy - rect.top
            };
        }

        // Interpolate between two points
        function interpolateAndDraw(x0, y0, x1, y1, fn) {
            const d = Math.hypot(x1 - x0, y1 - y0);
            const steps = Math.ceil(d / 2);
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                fn(
                    x0 + (x1 - x0) * t,
                    y0 + (y1 - y0) * t
                );
            }
        }

        // Handle pen‐drawing for environment tools
        function handleDraw(e) {
            e.preventDefault();
            const {
                x,
                y
            } = getCanvasCoords(e);
            const tool = document.getElementById('environment-tool').value;

            if (tool === 'none') {
                lastX = x; lastY = y;
                return;
            }

            // On first stroke point, lastX===null
            if (lastX === null) {
                snapshotEnvironment();
                lastX = x; lastY = y;
            }

            // Interpolate environment
            interpolateAndDraw(lastX, lastY, x, y, (ix, iy) => {
                if (tool === 'wall' || tool === 'water') {
                    environment.push({
                        x: ix, y: iy, type: tool
                    });
                } else if (tool === 'bulldozer') {
                    environment = environment.filter(o => Math.hypot(o.x - ix, o.y - iy) > 10);
                }
                // Visual feedback
                ctx.beginPath();
                ctx.strokeStyle = tool === 'wall' ? 'gray': tool === 'water' ? 'blue': 'red';
                ctx.lineWidth = 4;
                ctx.moveTo(ix, iy);
                ctx.lineTo(ix + 0.1, iy + 0.1);
                ctx.stroke();
            });

            lastX = x; lastY = y;
            saveFarm();
        }

        // Core initialization
        window.addEventListener('DOMContentLoaded', () => {
            canvas = document.getElementById('antCanvas');
            ctx = canvas.getContext('2d');
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            loadFarm();
            setupUI();
            animate();
        });

        // Resize canvas to viewport
        function resizeCanvas() {
            canvas.width = Math.max(200,
                Math.min(window.innerWidth - 320, 1000));
            canvas.height = window.innerHeight - 160;
        }

        // Wire up UI controls
        function setupUI() {
            const $ = id => document.getElementById(id);

            // Ant controls
            $.addAnt?.addEventListener('click',
                () => {
                    if (countWhiteAnts() < MAX_WHITE_ANTS) {
                        ants.push(createAnt(false));
                        totalBornWhite++;
                        updateStats();
                        saveFarm();
                    }
                });
            $.addRedAnt?.addEventListener('click',
                () => {
                    if (countRedAnts() < MAX_RED_ANTS) {
                        ants.push(createAnt(true));
                        totalBornRed++;
                        updateStats();
                        saveFarm();
                    }
                });
            $.killAllAnts?.addEventListener('click',
                () => {
                    ants = [];
                    updateStats();
                    saveFarm();
                });
            $.killRedAnts?.addEventListener('click',
                () => {
                    ants = ants.filter(a => !a.isRed);
                    updateStats();
                    saveFarm();
                });
            $.destroyWorld?.addEventListener('click',
                () => {
                    ants = [];
                    foods = [];
                    pheromones = [];
                    environment = [];
                    environmentHistory = [];
                    queens.white = queens.red = null;
                    whiteHappiness = 50;
                    totalBornWhite = totalDeadWhite = totalBornRed = totalDeadRed = 0;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    updateStats();
                    saveFarm();
                });

            // Sliders & checkboxes
            $.pauseResume?.addEventListener('click',
                e => {
                    animationPaused = !animationPaused;
                    e.target.innerText = animationPaused ? 'Resume': 'Pause';
                });
            $.allowRedBreeding?.addEventListener('change',
                e => {
                    allowRedBreeding = e.target.checked;
                    saveFarm();
                });
            $.matingSlider?.addEventListener('input',
                e => {
                    matingSpeed = 10000 - e.target.value * 90;
                    saveFarm();
                });
            $.lifespanSliderNormal?.addEventListener('input',
                e => {
                    normalAntLifespan = e.target.value * 1000;
                    saveFarm();
                });
            $.lifespanSliderRed?.addEventListener('input',
                e => {
                    redAntLifespan = e.target.value * 1000;
                    saveFarm();
                });
            $.redAggressionSlider?.addEventListener('input',
                e => {
                    redAggressionLevel = +e.target.value;
                    saveFarm();
                });

            // Undo button
            $.undoStructure?.addEventListener('click',
                () => {
                    if (environmentHistory.length) {
                        environment = environmentHistory.pop();
                        saveFarm();
                    }
                });

            // Single‐click food
            canvas.addEventListener('click',
                e => {
                    const tool = $('environment-tool').value;
                    if (tool === 'none') {
                        const {
                            x,
                            y
                        } = getCanvasCoords(e);
                        const ft = $('food-type').value || 'sugar';
                        if (foods.length < MAX_FOOD) foods.push({
                            x, y, type: ft
                        });
                        saveFarm();
                    }
                });

            // Pen‐drawing for environment
            canvas.addEventListener('mousedown',
                e => {
                    isDrawing = true; lastX = lastY = null;
                    handleDraw(e);
                    canvas.addEventListener('mousemove', handleDraw);
                });
            canvas.addEventListener('mouseup',
                () => {
                    isDrawing = false;
                    lastX = lastY = null;
                    canvas.removeEventListener('mousemove', handleDraw);
                });
            canvas.addEventListener('mouseleave',
                () => {
                    isDrawing = false;
                    lastX = lastY = null;
                    canvas.removeEventListener('mousemove', handleDraw);
                });

            // Touch equivalents
            canvas.addEventListener('touchstart',
                e => {
                    isDrawing = true; lastX = lastY = null;
                    handleDraw(e);
                    canvas.addEventListener('touchmove', handleDraw, {
                        passive: false
                    });
                });
            canvas.addEventListener('touchend',
                () => {
                    isDrawing = false;
                    lastX = lastY = null;
                    canvas.removeEventListener('touchmove', handleDraw);
                });
        }

        // Helpers
        function countWhiteAnts() {
            return ants.filter(a => !a.isRed).length;
        }
        function countRedAnts() {
            return ants.filter(a => a.isRed).length;
        }

        function createAnt(isRed = false, isQueen = false) {
            const base = isRed ? redAntLifespan: normalAntLifespan;
            const jitter = 1 + (Math.random()*0.2 - 0.1);
            return {
                x: Math.random()*canvas.width,
                y: Math.random()*canvas.height,
                angle: Math.random()*Math.PI*2,
                isRed, isQueen,
                speed: isQueen ? 0: (isRed ? 2: 1),
                breedingTimer: 0,
                lifespan: isQueen ? Infinity: base*jitter,
                spawnTimer: 0
            };
        }

        // Main loop
        function animate() {
            ctx.clearRect(0,
                0,
                canvas.width,
                canvas.height);
            drawEnvironment();
            drawFoods();
            drawPheromones();
            adjustWhiteHappiness();
            updateWhiteHappinessBar();

            if (!animationPaused) moveAndDrawAnts();
            else {
                ants.forEach(drawAnt);
                if (queens.white) drawAnt(queens.white);
                if (queens.red) drawAnt(queens.red);
            }

            requestAnimationFrame(animate);
        }

        // Draw environment features
        function drawEnvironment() {
            environment.forEach(o => {
                ctx.beginPath();
                ctx.fillStyle = o.type === 'wall' ? 'gray': 'blue';
                ctx.arc(o.x, o.y, 5, 0, Math.PI*2);
                ctx.fill();
            });
        }

        // Draw food
        function drawFoods() {
            foods.forEach(f => {
                ctx.beginPath();
                ctx.fillStyle = getFoodColor(f.type);
                ctx.arc(f.x, f.y, 5, 0, Math.PI*2);
                ctx.fill();
            });
        }

        // Draw pheromones
        function drawPheromones() {
            pheromones = pheromones.filter(p => p.strength > 0);
            pheromones.forEach(p => {
                ctx.beginPath();
                ctx.fillStyle = `rgba(255,255,0,${p.strength})`;
                ctx.arc(p.x, p.y, 2, 0, Math.PI*2);
                ctx.fill();
                p.strength -= 0.01;
            });
        }

        function getFoodColor(type) {
            switch (type) {
                case 'sugar': return 'white';
                    case 'protein': return 'green';
                        case 'spoiled': return 'blue';
                            case 'poison': return 'purple';
                                default: return 'white';
                                }
                        }

                        // Happiness bar
                        function updateWhiteHappinessBar() {
                            const bar = document.getElementById('happiness-bar');
                            if (!bar) return;
                            bar.style.width = `${whiteHappiness*2}px`;
                            let c = 'lime';
                            if (whiteHappiness < 25) c = 'red';
                            else if (whiteHappiness < 50) c = 'orange';
                            else if (whiteHappiness >= 75) c = queens.white ? 'purple': 'lime';
                            bar.style.background = c;
                    }

                    // Ant drawing & movement
                    function drawAnt(a) {
                        ctx.beginPath();
                        ctx.fillStyle = a.isRed ? 'red': 'white';
                        const r = a.isQueen ? 20: 5;
                        ctx.arc(a.x, a.y, r, 0, Math.PI*2);
                        ctx.fill();
                }

                function moveAndDrawAnts() {
                    ants.forEach(drawAnt);
                    if (queens.white) drawAnt(queens.white);
                    if (queens.red) drawAnt(queens.red);

                    if (whiteHappiness >= 75 && !queens.white) queens.white = createAnt(false, true);
                    if (whiteHappiness < 25 && !queens.red) queens.red = createAnt(true, true);

                    for (let i = ants.length-1; i >= 0; i--) {
                        const a = ants[i];
                        a.angle += (Math.random()-0.5)*0.2;

                        // Environment collision
                        const blocked = environment.some(o=>Math.hypot(o.x-a.x, o.y-a.y) < 5);
                        if (!a.isQueen && !blocked) {
                            if (a.isRed) {
                                // aggressive pursuit
                                const target = ants.find(o=>!o.isRed);
                                if (target) {
                                    const ang = Math.atan2(target.y-a.y, target.x-a.x);
                                    a.angle += (ang - a.angle)*(redAggressionLevel/100);
                                    if (Math.hypot(a.x-target.x, a.y-target.y) < 10) {
                                        ants.splice(ants.indexOf(target), 1);
                                        totalDeadWhite++;
                                        updateStats();
                                    }
                                }
                            } else {
                                // pheromone or food seeking
                                const ph = pheromones.find(p=>Math.hypot(p.x-a.x, p.y-a.y) < 20);
                                if (ph) {
                                    const ang = Math.atan2(ph.y-a.y, ph.x-a.x);
                                    a.angle += (ang - a.angle)*0.05;
                                } else if (foods.length > 0) {
                                    const nearest = foods.reduce((u, v)=>((u.x-a.x)**2+(u.y-a.y)**2) < ((v.x-a.x)**2+(v.y-a.y)**2)?u: v);
                                    const ang = Math.atan2(nearest.y-a.y, nearest.x-a.x);
                                    a.angle += (ang - a.angle)*0.1;
                                    if (Math.hypot(a.x-nearest.x, a.y-nearest.y) < 10) {
                                        foods.splice(foods.indexOf(nearest), 1);
                                        pheromones.push({
                                            x: a.x, y: a.y, strength: 1
                                        });
                                    }
                                }
                            }
                            // move
                            a.x += Math.cos(a.angle)*a.speed;
                            a.y += Math.sin(a.angle)*a.speed;
                            if (a.x < 0) a.x = canvas.width;
                            if (a.x > canvas.width) a.x = 0;
                            if (a.y < 0) a.y = canvas.height;
                            if (a.y > canvas.height) a.y = 0;
                        }

                        // sidestep if too close
                        ants.forEach(o=> {
                            if (o !== a && Math.hypot(a.x-o.x, a.y-o.y) < 2) {
                                a.angle += Math.PI/2;
                            }
                        });

                        // lifespan & breeding
                        a.lifespan -= 16;
                        if (a.lifespan <= 0 && !a.isQueen) {
                            a.isRed ? totalDeadRed++: totalDeadWhite++;
                            ants.splice(i, 1);
                            updateStats();
                            continue;
                        }

                        a.breedingTimer = (a.breedingTimer || 0) + 16;
                        if (!a.isQueen && a.breedingTimer >= matingSpeed) {
                            tryBreeding(a);
                            a.breedingTimer = 0;
                        }

                        if (a.isQueen) {
                            a.spawnTimer = (a.spawnTimer || 0)+16;
                            if (a.spawnTimer >= 3000) {
                                ants.push(createAnt(a.isRed));
                                a.isRed ? totalBornRed++: totalBornWhite++;
                                a.spawnTimer = 0;
                            }
                        }
                    }
            }

            // breeding logic
            function tryBreeding(a) {
                ants.forEach(o=> {
                    if (o === a || o.isQueen) return;
                    if (Math.hypot(a.x-o.x, a.y-o.y) < 30) {
                        if (a.isRed && o.isRed && allowRedBreeding && countRedAnts() < MAX_RED_ANTS && Math.random() < 0.1) {
                            ants.push(createAnt(true)); totalBornRed++;
                        } else if (!a.isRed&&!o.isRed && countWhiteAnts() < MAX_WHITE_ANTS && Math.random() < 0.1) {
                            ants.push(createAnt(false)); totalBornWhite++;
                        }
                    }
                });
                updateStats();
            }

            // stats display
            function updateStats() {
                const el = document.getElementById('stats');
                if (!el) return;
                el.innerHTML =
                `Total Alive: ${ants.length}<br>`+
                `White Ants: Alive: ${countWhiteAnts()} | Born: ${totalBornWhite} | Dead: ${totalDeadWhite}<br>`+
                `Red Ants: Alive: ${countRedAnts()} | Born: ${totalBornRed} | Dead: ${totalDeadRed}`;
            }

            // persistence
            function saveFarm() {
                localStorage.setItem(SAVE_KEY, JSON.stringify({
                    ants, foods, pheromones, environment,
                    totalBornWhite, totalDeadWhite, totalBornRed, totalDeadRed,
                    matingSpeed, normalAntLifespan, redAntLifespan,
                    allowRedBreeding, redAggressionLevel, whiteHappiness
                }));
            }

            function loadFarm() {
                const s = localStorage.getItem(SAVE_KEY);
                if (!s) return;
                const d = JSON.parse(s);
                ants = (d.ants || []).map(a=>({
                    ...a, breedingTimer: 0, spawnTimer: 0
                }));
                foods = d.foods || [];
                pheromones = d.pheromones || [];
                environment = d.environment || [];
                totalBornWhite = d.totalBornWhite || 0;
                totalDeadWhite = d.totalDeadWhite || 0;
                totalBornRed = d.totalBornRed || 0;
                totalDeadRed = d.totalDeadRed || 0;
                matingSpeed = d.matingSpeed || 5000;
                normalAntLifespan = d.normalAntLifespan || 10000;
                redAntLifespan = d.redAntLifespan || 10000;
                allowRedBreeding = d.allowRedBreeding !== undefined?d.allowRedBreeding: true;
                redAggressionLevel = d.redAggressionLevel || 50;
                whiteHappiness = d.whiteHappiness || 50;
                updateStats();
            }
        </script>
    </body>
    </html>